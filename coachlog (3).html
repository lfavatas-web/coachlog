<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoachLog ‚Äî Observation Tool</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,700;1,500&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --ink:#1a1a2e;--ink-light:#4a4a6a;--ink-muted:#9090b0;--cream:#f7f5f0;--cream-dark:#ede9e0;
    --accent:#c8553d;--accent-light:#f0d5cf;--teal:#2a7f7f;--teal-light:#d0eaea;--gold:#c9a84c;
    --private:#fff3e0;--private-border:#e0a020;--shared:#e8f5e9;--shared-border:#43a047;
    --shadow:0 4px 24px rgba(26,26,46,.10);--shadow-lg:0 8px 40px rgba(26,26,46,.18);
    --s4:#1e7e4a;--s3:#2471a3;--s2:#d4851a;--s1:#c0392b;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--ink);min-height:100vh;}

  /* AUTH */
  #auth-wrapper{display:none;min-height:100vh;position:relative;overflow:hidden;}
  #auth-wrapper.active{display:flex;}
  .auth-bg{position:absolute;inset:0;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);z-index:0;}
  .auth-bg::before{content:'';position:absolute;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(201,168,76,.12) 0%,transparent 70%);top:-150px;right:-150px;}
  .auth-bg::after{content:'';position:absolute;width:400px;height:400px;border-radius:50%;background:radial-gradient(circle,rgba(42,127,127,.15) 0%,transparent 70%);bottom:-100px;left:-100px;}
  .auth-left{flex:1;display:flex;flex-direction:column;justify-content:center;padding:4rem;position:relative;z-index:1;}
  @media(max-width:820px){.auth-left{display:none;}}
  .auth-brand{font-family:'Playfair Display',serif;font-size:3.5rem;color:white;line-height:1.1;margin-bottom:1.5rem;}
  .auth-brand span{color:var(--gold);}
  .auth-tagline{color:rgba(255,255,255,.6);font-size:1.1rem;line-height:1.7;max-width:380px;margin-bottom:3rem;}
  .auth-features{display:flex;flex-direction:column;gap:1rem;}
  .auth-feature{display:flex;align-items:center;gap:.9rem;color:rgba(255,255,255,.75);font-size:.95rem;}
  .auth-feature-icon{width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
  .auth-right{width:460px;min-height:100vh;background:var(--cream);display:flex;align-items:center;justify-content:center;padding:3rem 2.5rem;position:relative;z-index:1;flex-shrink:0;}
  @media(max-width:820px){.auth-right{width:100%;}}
  .auth-form-box{width:100%;max-width:380px;}
  .auth-form-logo{font-family:'Playfair Display',serif;font-size:1.8rem;color:var(--ink);margin-bottom:.3rem;}
  .auth-form-logo span{color:var(--teal);}
  .auth-form-subtitle{color:var(--ink-muted);font-size:.9rem;margin-bottom:2rem;}
  .auth-tabs{display:flex;border-bottom:2px solid var(--cream-dark);margin-bottom:1.8rem;}
  .auth-tab{flex:1;padding:.7rem;text-align:center;cursor:pointer;font-size:.9rem;font-weight:500;color:var(--ink-muted);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s;background:none;border-left:none;border-right:none;border-top:none;font-family:'DM Sans',sans-serif;}
  .auth-tab.active{color:var(--teal);border-bottom-color:var(--teal);font-weight:600;}
  .auth-field{margin-bottom:1.1rem;}
  .auth-field label{display:block;font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--ink-light);margin-bottom:.4rem;}
  .auth-field input{width:100%;padding:.75rem 1rem;border:1.5px solid var(--cream-dark);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.95rem;color:var(--ink);background:white;outline:none;transition:border .2s,box-shadow .2s;}
  .auth-field input:focus{border-color:var(--teal);box-shadow:0 0 0 3px var(--teal-light);}
  .auth-error{background:var(--accent-light);color:var(--accent);border:1px solid #e8b0a0;border-radius:8px;padding:.7rem 1rem;font-size:.88rem;margin-bottom:1rem;display:none;}
  .auth-error.show{display:block;}
  .btn-auth{width:100%;background:var(--teal);color:white;border:none;padding:.85rem;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s;margin-top:.5rem;box-shadow:0 2px 12px rgba(42,127,127,.3);}
  .btn-auth:hover{background:#1e6060;transform:translateY(-1px);}
  .auth-footer-text{margin-top:1.5rem;text-align:center;font-size:.82rem;color:var(--ink-muted);}
  .pw-strength{height:4px;border-radius:2px;margin-top:.4rem;background:var(--cream-dark);overflow:hidden;}
  .pw-strength-bar{height:100%;border-radius:2px;transition:width .3s,background .3s;width:0%;}
  .pw-hint{font-size:.75rem;color:var(--ink-muted);margin-top:.3rem;}

  /* APP */
  #app-wrapper{display:none;flex-direction:column;min-height:100vh;}
  #app-wrapper.active{display:flex;}
  header{background:var(--ink);color:white;padding:0 2.5rem;display:flex;align-items:center;justify-content:space-between;height:70px;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,.3);flex-shrink:0;}
  .logo{font-family:'Playfair Display',serif;font-size:1.4rem;letter-spacing:.02em;}
  .logo span{color:var(--gold);}
  .header-right{display:flex;align-items:center;gap:.8rem;}
  .header-coach-info{text-align:right;font-size:.8rem;color:rgba(255,255,255,.6);line-height:1.3;}
  .header-coach-info strong{color:white;font-size:.88rem;display:block;}
  header nav{display:flex;gap:.5rem;align-items:center;}
  header nav button{background:none;border:1.5px solid rgba(255,255,255,.2);color:white;padding:.45rem 1.1rem;border-radius:6px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:500;transition:all .2s;}
  header nav button:hover,header nav button.active{background:var(--accent);border-color:var(--accent);}
  .btn-signout{background:none;border:1.5px solid rgba(255,255,255,.15);color:rgba(255,255,255,.7);padding:.4rem .9rem;border-radius:6px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.82rem;transition:all .2s;}
  .btn-signout:hover{border-color:rgba(255,255,255,.4);color:white;}
  @media(max-width:700px){.header-coach-info{display:none;}header{padding:0 1rem;}}

  /* DROPDOWN */
  .new-log-wrapper{position:relative;}
  .new-log-btn{background:var(--accent);color:white;border:none;padding:.45rem 1.1rem;border-radius:6px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;display:flex;align-items:center;gap:.4rem;transition:all .2s;white-space:nowrap;}
  .new-log-btn:hover{background:#b04030;}
  .new-log-btn .caret{font-size:.65rem;transition:transform .2s;}
  .new-log-btn.open .caret{transform:rotate(180deg);}
  .new-log-menu{position:absolute;top:calc(100% + 8px);right:0;background:white;border-radius:10px;box-shadow:var(--shadow-lg);min-width:240px;overflow:hidden;z-index:200;display:none;}
  .new-log-menu.open{display:block;}
  .new-log-menu-label{padding:.6rem 1rem;font-size:.72rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ink-muted);border-bottom:1px solid var(--cream-dark);}
  .new-log-option{display:flex;align-items:flex-start;gap:.8rem;padding:.85rem 1rem;cursor:pointer;transition:background .15s;border:none;background:none;width:100%;font-family:'DM Sans',sans-serif;text-align:left;}
  .new-log-option:hover{background:var(--cream);}
  .new-log-option-icon{font-size:1.3rem;flex-shrink:0;margin-top:.1rem;}
  .new-log-option-text strong{display:block;font-size:.9rem;font-weight:600;color:var(--ink);margin-bottom:.15rem;}
  .new-log-option-text span{font-size:.78rem;color:var(--ink-muted);line-height:1.4;}
  .new-log-option+.new-log-option{border-top:1px solid var(--cream-dark);}

  /* LAYOUT */
  .container{max-width:1100px;margin:0 auto;padding:2.5rem 2rem;}
  @media(max-width:700px){.container{padding:1.5rem 1rem;}}
  .view{display:none;}
  .view.active{display:block;}

  /* BUTTONS */
  .btn-primary{background:var(--accent);color:white;border:none;padding:.7rem 1.5rem;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.95rem;font-weight:600;display:flex;align-items:center;gap:.5rem;transition:all .2s;box-shadow:0 2px 10px rgba(200,85,61,.3);}
  .btn-primary:hover{background:#b04030;transform:translateY(-1px);}
  .btn-secondary{background:white;color:var(--ink);border:1.5px solid var(--cream-dark);padding:.6rem 1.2rem;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.9rem;font-weight:500;transition:all .2s;}
  .btn-secondary:hover{border-color:var(--ink-light);background:var(--cream);}
  .btn-teal{background:var(--teal);color:white;border:none;padding:.6rem 1.2rem;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.9rem;font-weight:500;transition:all .2s;}
  .btn-teal:hover{background:#1e6060;}
  .btn-danger{background:none;color:var(--accent);border:1.5px solid var(--accent-light);padding:.5rem 1rem;border-radius:6px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;transition:all .2s;}
  .btn-danger:hover{background:var(--accent-light);}
  .btn-back{background:none;border:none;color:var(--ink-light);cursor:pointer;font-size:1.3rem;padding:.3rem;transition:color .2s;}
  .btn-back:hover{color:var(--ink);}

  /* DASHBOARD */
  .dashboard-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:2rem;}
  .dashboard-header h1{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;}
  .filters{display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;}
  .filters input,.filters select{padding:.6rem 1rem;border:1.5px solid var(--cream-dark);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.9rem;background:white;color:var(--ink);outline:none;transition:border .2s;}
  .filters input:focus,.filters select:focus{border-color:var(--teal);}
  .filters input{flex:1;min-width:180px;}
  .obs-grid{display:grid;gap:1rem;}
  .obs-card{background:white;border-radius:12px;padding:1.5rem;box-shadow:var(--shadow);display:grid;grid-template-columns:1fr auto;gap:1rem;align-items:start;transition:transform .15s,box-shadow .15s;cursor:pointer;}
  .obs-card.type-general{border-left:4px solid var(--teal);}
  .obs-card.type-di{border-left:4px solid var(--gold);}
  .obs-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg);}
  .obs-card-info h3{font-family:'Playfair Display',serif;font-size:1.15rem;margin-bottom:.3rem;}
  .obs-card-meta{display:flex;gap:1rem;font-size:.82rem;color:var(--ink-muted);margin-bottom:.6rem;flex-wrap:wrap;}
  .obs-card-preview{font-size:.88rem;color:var(--ink-light);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
  .obs-card-actions{display:flex;flex-direction:column;gap:.5rem;align-items:flex-end;}
  .empty-state{text-align:center;padding:4rem 2rem;color:var(--ink-muted);}
  .empty-state .icon{font-size:3rem;margin-bottom:1rem;}
  .empty-state h3{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--ink-light);margin-bottom:.5rem;}
  .chip{display:inline-flex;align-items:center;border-radius:20px;padding:.2rem .7rem;font-size:.78rem;font-weight:600;}
  .chip-teal{background:var(--teal-light);color:var(--teal);}
  .chip-gold{background:#fef3cd;color:#9a6f00;}

  /* GENERAL FORM */
  .form-header{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;}
  .form-header h1{font-family:'Playfair Display',serif;font-size:1.8rem;}
  .form-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.2rem;margin-bottom:1.5rem;}
  @media(max-width:700px){.form-grid{grid-template-columns:1fr;}}
  .field-group{display:flex;flex-direction:column;gap:.4rem;}
  .field-group label{font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--ink-light);}
  .badge-private{display:inline-block;background:var(--private);color:var(--private-border);border:1px solid var(--private-border);font-size:.65rem;padding:.1rem .4rem;border-radius:4px;font-weight:600;margin-left:.4rem;vertical-align:middle;}
  .badge-shared{display:inline-block;background:var(--shared);color:var(--shared-border);border:1px solid var(--shared-border);font-size:.65rem;padding:.1rem .4rem;border-radius:4px;font-weight:600;margin-left:.4rem;vertical-align:middle;}
  .field-group input,.field-group textarea{padding:.65rem .9rem;border:1.5px solid var(--cream-dark);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.92rem;color:var(--ink);background:white;outline:none;transition:border .2s,box-shadow .2s;resize:vertical;}
  .field-group input:focus,.field-group textarea:focus{border-color:var(--teal);box-shadow:0 0 0 3px var(--teal-light);}
  .section-card{background:white;border-radius:12px;padding:1.5rem;box-shadow:var(--shadow);margin-bottom:1.2rem;}
  .section-card.private-section{background:var(--private);border:1.5px solid var(--private-border);}
  .section-card.private-section .field-group textarea{background:#fffbf4;border-color:#e8c070;}
  .section-title{font-weight:600;font-size:.85rem;text-transform:uppercase;letter-spacing:.07em;color:var(--ink-light);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;}
  .section-title.private-title{color:var(--private-border);}
  .running-record-area{display:flex;flex-direction:column;gap:.8rem;}
  .timestamp-entry{display:flex;gap:.8rem;align-items:flex-start;}
  .timestamp-label{font-family:'DM Mono',monospace;font-size:.78rem;color:var(--private-border);background:white;border:1px solid var(--private-border);border-radius:5px;padding:.4rem .6rem;white-space:nowrap;margin-top:.1rem;min-width:80px;text-align:center;}
  .timestamp-text{flex:1;padding:.55rem .85rem;border:1.5px solid #e8c070;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.9rem;background:#fffbf4;outline:none;resize:none;min-height:42px;line-height:1.4;transition:border .2s;}
  .timestamp-text:focus{border-color:var(--private-border);}
  .add-timestamp-btn{display:flex;align-items:center;gap:.5rem;background:none;border:1.5px dashed var(--private-border);color:var(--private-border);padding:.6rem 1rem;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:500;transition:all .2s;width:fit-content;}
  .add-timestamp-btn:hover{background:white;}
  .remove-ts{background:none;border:none;color:var(--ink-muted);cursor:pointer;font-size:1rem;padding:.2rem;line-height:1;margin-top:.4rem;transition:color .2s;}
  .remove-ts:hover{color:var(--accent);}
  .form-actions{display:flex;gap:1rem;justify-content:flex-end;padding-top:1rem;flex-wrap:wrap;}

  /* DETAIL */
  .detail-header{background:white;border-radius:12px;padding:2rem;box-shadow:var(--shadow);margin-bottom:1.5rem;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:1rem;}
  .detail-header h1{font-family:'Playfair Display',serif;font-size:1.8rem;}
  .detail-meta{display:flex;gap:1.5rem;font-size:.9rem;color:var(--ink-light);margin-top:.4rem;flex-wrap:wrap;}
  .detail-actions{display:flex;gap:.6rem;flex-wrap:wrap;}
  .detail-section{background:white;border-radius:12px;padding:1.5rem;box-shadow:var(--shadow);margin-bottom:1rem;}
  .detail-section.private-section{background:var(--private);border:1.5px solid var(--private-border);}
  .detail-section h3{font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--ink-muted);margin-bottom:.8rem;}
  .detail-section.private-section h3{color:var(--private-border);}
  .detail-section p{line-height:1.7;color:var(--ink);font-size:.95rem;white-space:pre-wrap;}
  .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
  @media(max-width:600px){.detail-grid{grid-template-columns:1fr;}}
  .ts-list{display:flex;flex-direction:column;gap:.7rem;}
  .ts-item{display:flex;gap:.8rem;align-items:flex-start;}
  .ts-badge{font-family:'DM Mono',monospace;font-size:.75rem;background:white;border:1px solid var(--private-border);color:var(--private-border);border-radius:4px;padding:.25rem .5rem;white-space:nowrap;margin-top:.1rem;}
  .ts-content{font-size:.9rem;line-height:1.5;color:var(--ink);}

  /* SHARE */
  .share-banner{background:var(--teal);color:white;padding:1rem 1.5rem;border-radius:10px;margin-bottom:1.5rem;display:flex;align-items:center;gap:.8rem;font-size:.9rem;}

  /* MODAL */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(26,26,46,.5);z-index:200;align-items:center;justify-content:center;}
  .modal-overlay.open{display:flex;}
  .modal{background:white;border-radius:16px;padding:2rem;max-width:500px;width:90%;box-shadow:var(--shadow-lg);}
  .modal h2{font-family:'Playfair Display',serif;font-size:1.4rem;margin-bottom:.5rem;}
  .modal p{color:var(--ink-light);font-size:.9rem;margin-bottom:1.5rem;line-height:1.6;}
  .modal-actions{display:flex;gap:.8rem;justify-content:flex-end;}
  .share-link-box{background:var(--cream);border:1.5px solid var(--cream-dark);border-radius:8px;padding:.8rem 1rem;font-family:'DM Mono',monospace;font-size:.78rem;word-break:break-all;color:var(--teal);margin-bottom:1rem;user-select:all;cursor:text;}
  .copied-msg{display:none;color:var(--teal);font-size:.85rem;font-weight:600;margin-top:.5rem;}

  /* ===== DI RUBRIC ===== */
  #view-di-form .container{max-width:960px;}
  .di-meta-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:1rem;background:white;border-radius:12px;padding:1.5rem;box-shadow:var(--shadow);margin-bottom:1.5rem;}
  .di-meta-field{display:flex;flex-direction:column;gap:.3rem;}
  .di-meta-field label{font-size:.72rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ink-muted);}
  .di-meta-field input{background:transparent;border:none;border-bottom:1.5px solid var(--cream-dark);padding:.4rem 2px;font-family:'DM Sans',sans-serif;font-size:.92rem;color:var(--ink);outline:none;transition:border-color .2s;}
  .di-meta-field input:focus{border-color:var(--accent);}
  .di-legend{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1.2rem;align-items:center;}
  .di-legend-item{display:flex;align-items:center;gap:.5rem;font-size:.8rem;font-weight:600;}
  .di-legend-dot{width:11px;height:11px;border-radius:50%;}
  .rubric-section{background:white;border-radius:12px;overflow:hidden;box-shadow:var(--shadow);margin-bottom:1.2rem;}
  .rubric-section-header{background:var(--ink);color:white;padding:1rem 1.5rem;display:flex;align-items:center;gap:.8rem;}
  .rubric-section-num{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--gold);}
  .rubric-section-title{font-size:.82rem;font-weight:600;letter-spacing:.12em;text-transform:uppercase;}
  .rubric-table{width:100%;border-collapse:collapse;}
  .rubric-table th{padding:.65rem 1rem;font-size:.7rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ink-muted);border-bottom:1.5px solid var(--cream-dark);text-align:left;}
  .rubric-table th.col-score,.rubric-table td.col-score{width:100px;text-align:center;}
  .rubric-table th.col-obs,.rubric-table td.col-obs{width:90px;text-align:center;}
  .rubric-table td{padding:1rem;border-bottom:1px solid var(--cream-dark);vertical-align:top;font-size:.88rem;line-height:1.55;color:var(--ink);}
  .rubric-table tr:last-child td{border-bottom:none;}
  .score-cell{text-align:center;vertical-align:middle!important;}
  .score-badge-di{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:50%;font-weight:700;font-size:.9rem;color:white;margin-bottom:3px;}
  .score-lbl{display:block;font-size:.65rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;margin-top:2px;}
  .s4b{background:var(--s4);}  .s4l{color:var(--s4);}
  .s3b{background:var(--s3);}  .s3l{color:var(--s3);}
  .s2b{background:var(--s2);}  .s2l{color:var(--s2);}
  .s1b{background:var(--s1);}  .s1l{color:var(--s1);}
  .chk-wrap{display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;}
  .chk-wrap input{display:none;}
  .chk-box{width:22px;height:22px;border:2px solid #ccc;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .15s;background:white;}
  .chk-wrap input:checked~.chk-box{border-color:transparent;}
  .chk-wrap.c4 input:checked~.chk-box{background:var(--s4);}
  .chk-wrap.c3 input:checked~.chk-box{background:var(--s3);}
  .chk-wrap.c2 input:checked~.chk-box{background:var(--s2);}
  .chk-wrap.c1 input:checked~.chk-box{background:var(--s1);}
  .chk-box::after{content:'';display:none;width:6px;height:10px;border:2px solid white;border-top:none;border-left:none;transform:rotate(40deg) translateY(-1px);}
  .chk-wrap input:checked~.chk-box::after{display:block;}
  /* DI Summary */
  .di-summary{background:var(--ink);color:white;border-radius:12px;padding:1.2rem 1.8rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin-bottom:1.2rem;}
  .di-summary h3{font-family:'Playfair Display',serif;font-size:1rem;color:var(--gold);}
  .di-summary-scores{display:flex;gap:1rem;flex-wrap:wrap;}
  .di-summary-scores span{font-size:.8rem;font-weight:600;}
  .di-total{font-family:'Playfair Display',serif;font-size:1.5rem;color:var(--gold);}
  /* DI shared cards */
  .di-shared-card{background:white;border-radius:12px;padding:1.5rem;box-shadow:var(--shadow);margin-bottom:1.2rem;border-left:4px solid var(--shared-border);}
  .di-shared-card .section-title{color:var(--shared-border);}
  .di-shared-card .field-group textarea{border-color:var(--cream-dark);}
  .di-shared-card .field-group textarea:focus{border-color:var(--teal);box-shadow:0 0 0 3px var(--teal-light);}
  /* DI private cards */
  .di-notes-card{background:var(--private);border:1.5px solid var(--private-border);border-radius:12px;padding:1.5rem;box-shadow:var(--shadow);margin-bottom:1.2rem;}
  .di-notes-card h3,.di-notes-card .section-title{font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--private-border);margin-bottom:.8rem;}
  .di-notes-card textarea{width:100%;border:1.5px solid #e8c070;border-radius:8px;padding:.75rem 1rem;font-family:'DM Sans',sans-serif;font-size:.9rem;background:#fffbf4;outline:none;resize:vertical;min-height:100px;color:var(--ink);}
  .di-notes-card textarea:focus{border-color:var(--private-border);}
  /* DI detail */
  .di-rubric-detail{background:white;border-radius:12px;box-shadow:var(--shadow);margin-bottom:1rem;overflow:hidden;}
  .di-rubric-detail-header{background:var(--ink);color:white;padding:.8rem 1.2rem;display:flex;align-items:center;gap:.6rem;}
  .di-rubric-detail-content{padding:1rem 1.5rem;}
  .di-score-display{display:flex;align-items:center;gap:.8rem;margin-bottom:.5rem;}
  .di-score-pill{padding:.25rem .8rem;border-radius:20px;font-size:.8rem;font-weight:700;color:white;}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth-wrapper">
  <div class="auth-bg"></div>
  <div class="auth-left">
    <div class="auth-brand">Coach<span>Log</span></div>
    <p class="auth-tagline">A private workspace for instructional coaches to capture, reflect on, and share classroom observations.</p>
    <div class="auth-features">
      <div class="auth-feature"><div class="auth-feature-icon">üîí</div>Coach-only notes stay completely private</div>
      <div class="auth-feature"><div class="auth-feature-icon">‚è±Ô∏è</div>Timestamped running records during visits</div>
      <div class="auth-feature"><div class="auth-feature-icon">üìä</div>Direct Instruction rubric with scoring</div>
      <div class="auth-feature"><div class="auth-feature-icon">üîó</div>Share polished summaries with teachers</div>
    </div>
  </div>
  <div class="auth-right">
    <div class="auth-form-box">
      <div class="auth-form-logo">Coach<span>Log</span></div>
      <div class="auth-form-subtitle">Instructional Coaching Tool</div>
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
        <button class="auth-tab" onclick="switchAuthTab('signup')">Create Account</button>
      </div>
      <div class="auth-error" id="auth-error"></div>
      <div id="login-form">
        <div class="auth-field"><label>Email Address</label><input type="email" id="login-email" placeholder="you@school.edu" autocomplete="email"></div>
        <div class="auth-field"><label>Password</label><input type="password" id="login-password" placeholder="Your password" autocomplete="current-password"></div>
        <button class="btn-auth" onclick="handleLogin()">Sign In &rarr;</button>
        <div class="auth-footer-text">No account? <a href="#" style="color:var(--teal);text-decoration:none;font-weight:600;" onclick="switchAuthTab('signup');return false;">Create one free</a></div>
      </div>
      <div id="signup-form" style="display:none;">
        <div class="auth-field"><label>Full Name</label><input type="text" id="signup-name" placeholder="Your name" autocomplete="name"></div>
        <div class="auth-field"><label>Email Address</label><input type="email" id="signup-email" placeholder="you@school.edu" autocomplete="email"></div>
        <div class="auth-field"><label>Password</label><input type="password" id="signup-password" placeholder="Min. 6 characters" autocomplete="new-password" oninput="checkPwStrength(this.value)">
          <div class="pw-strength"><div class="pw-strength-bar" id="pw-bar"></div></div>
          <div class="pw-hint" id="pw-hint">Choose a strong password</div>
        </div>
        <div class="auth-field"><label>Confirm Password</label><input type="password" id="signup-confirm" placeholder="Repeat password" autocomplete="new-password"></div>
        <button class="btn-auth" style="background:var(--accent);box-shadow:0 2px 12px rgba(200,85,61,.3);" onclick="handleSignup()">Create Account &rarr;</button>
        <div class="auth-footer-text">Have an account? <a href="#" style="color:var(--teal);text-decoration:none;font-weight:600;" onclick="switchAuthTab('login');return false;">Sign in</a></div>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app-wrapper">
  <header>
    <div class="logo">Coach<span>Log</span></div>
    <div class="header-right">
      <div class="header-coach-info">
        <strong id="header-name"></strong>
        <span id="header-email"></span>
      </div>
      <nav>
        <button class="active" onclick="showView('dashboard')">All Observations</button>
        <div class="new-log-wrapper" id="new-log-wrapper">
          <button class="new-log-btn" id="new-log-toggle" onclick="toggleLogMenu()">&#43; New Log <span class="caret">‚ñº</span></button>
          <div class="new-log-menu" id="new-log-menu">
            <div class="new-log-menu-label">Choose Log Type</div>
            <button class="new-log-option" onclick="newObservation('general')">
              <span class="new-log-option-icon">üìã</span>
              <div class="new-log-option-text"><strong>General Observation</strong><span>Running record, action steps &amp; coach notes</span></div>
            </button>
            <button class="new-log-option" onclick="newObservation('di')">
              <span class="new-log-option-icon">üìä</span>
              <div class="new-log-option-text"><strong>Direct Instruction Observation</strong><span>Scored rubric across 6 instructional domains</span></div>
            </button>
          </div>
        </div>
      </nav>
      <button class="btn-signout" onclick="handleSignOut()">Sign Out</button>
    </div>
  </header>

  <!-- DASHBOARD -->
  <div id="view-dashboard" class="view active">
    <div class="container">
      <div class="dashboard-header"><h1>Observation Logs</h1></div>
      <div class="filters">
        <input type="text" id="search-input" placeholder="Search by teacher name or section..." oninput="renderDashboard()">
        <select id="sort-select" onchange="renderDashboard()">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="name">Teacher Name (A‚ÄìZ)</option>
        </select>
      </div>
      <div class="obs-grid" id="obs-grid"></div>
    </div>
  </div>

  <!-- GENERAL FORM -->
  <div id="view-form" class="view">
    <div class="container">
      <div class="form-header">
        <button class="btn-back" onclick="showView('dashboard')">&#8592;</button>
        <h1 id="form-title">New Observation</h1>
      </div>
      <div class="section-card">
        <div class="section-title">üìã Observation Info</div>
        <div class="form-grid">
          <div class="field-group"><label>Teacher Name <span class="badge-shared">Shared</span></label><input type="text" id="f-teacher" placeholder="Full name"></div>
          <div class="field-group"><label>Date <span class="badge-shared">Shared</span></label><input type="date" id="f-date"></div>
          <div class="field-group"><label>Section / Period <span class="badge-shared">Shared</span></label><input type="text" id="f-section" placeholder="e.g. Period 3, 8th Grade ELA"></div>
        </div>
        <div class="form-grid" style="grid-template-columns:1fr 1fr;">
          <div class="field-group"><label>Objective <span class="badge-shared">Shared</span></label><textarea id="f-objective" rows="3" placeholder="Lesson objective..."></textarea></div>
          <div class="field-group"><label>Do Now <span class="badge-shared">Shared</span></label><textarea id="f-donow" rows="3" placeholder="Do now / warm-up activity..."></textarea></div>
        </div>
        <div class="field-group" style="margin-top:.5rem;"><label>Action Step <span class="badge-shared">Shared</span></label><textarea id="f-action" rows="3" placeholder="Key action step for the teacher..."></textarea></div>
      </div>
      <div class="section-card private-section">
        <div class="section-title private-title">üîí Running Record <span class="badge-private">Coach Only</span></div>
        <div class="running-record-area" id="running-record-entries"></div>
        <button class="add-timestamp-btn" onclick="addTimestamp()" style="margin-top:.8rem;">&#43; Add Timestamped Entry</button>
      </div>
      <div class="section-card private-section">
        <div class="section-title private-title">üîí Coach-Only Notes <span class="badge-private">Not Shared</span></div>
        <div class="field-group"><textarea id="f-coachnotes" rows="4" placeholder="Private reflections, patterns, follow-up questions..."></textarea></div>
      </div>
      <div class="form-actions">
        <button class="btn-secondary" onclick="showView('dashboard')">Cancel</button>
        <button class="btn-teal" onclick="saveObservation()">üíæ Save Observation</button>
      </div>
    </div>
  </div>

  <!-- DI FORM -->
  <div id="view-di-form" class="view">
    <div class="container" style="max-width:960px;">
      <div class="form-header">
        <button class="btn-back" onclick="showView('dashboard')">&#8592;</button>
        <h1 id="di-form-title">Direct Instruction Observation</h1>
      </div>
      <!-- Meta -->
      <div class="di-meta-grid">
        <div class="di-meta-field"><label>Teacher Name</label><input type="text" id="di-teacher" placeholder="‚Äî"></div>
        <div class="di-meta-field"><label>Date</label><input type="date" id="di-date"></div>
        <div class="di-meta-field"><label>Grade / Subject</label><input type="text" id="di-grade" placeholder="‚Äî"></div>
        <div class="di-meta-field"><label>Lesson Topic</label><input type="text" id="di-topic" placeholder="‚Äî"></div>
        <div class="di-meta-field"><label>Period / Section</label><input type="text" id="di-section" placeholder="‚Äî"></div>
      </div>
      <!-- Legend -->
      <div class="di-legend">
        <div class="di-legend-item"><div class="di-legend-dot" style="background:var(--s4)"></div>4 ‚Äî Exemplary</div>
        <div class="di-legend-item"><div class="di-legend-dot" style="background:var(--s3)"></div>3 ‚Äî Proficient</div>
        <div class="di-legend-item"><div class="di-legend-dot" style="background:var(--s2)"></div>2 ‚Äî Developing</div>
        <div class="di-legend-item"><div class="di-legend-dot" style="background:var(--s1)"></div>1 ‚Äî Beginning</div>
      </div>
      <!-- Rubric sections rendered by JS -->
      <div id="di-rubric-sections"></div>
      <!-- Live summary -->
      <div class="di-summary">
        <div>
          <h3>Observation Summary</h3>
          <div class="di-summary-scores" id="di-summary-scores"><span style="color:rgba(255,255,255,.5);font-size:.82rem;">No scores recorded yet.</span></div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:.7rem;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,.4);">Total</div>
          <div class="di-total" id="di-total">‚Äî</div>
          <div style="font-size:.7rem;color:rgba(255,255,255,.4);">/ 24</div>
        </div>
      </div>

      <!-- TEACHER-FACING: Notes + Action Step -->
      <div class="di-shared-card">
        <div class="section-title" style="color:var(--shared-border);">üìù Teacher-Facing Notes &amp; Action Step <span class="badge-shared">Shared with Teacher</span></div>
        <div class="field-group" style="margin-bottom:1rem;">
          <label>Notes <span class="badge-shared">Shared</span></label>
          <textarea id="di-notes" rows="4" placeholder="Observations, strengths, and areas for growth to share with the teacher..."></textarea>
        </div>
        <div class="field-group">
          <label>Action Step <span class="badge-shared">Shared</span></label>
          <textarea id="di-actionstep" rows="3" placeholder="A clear, specific next step for the teacher to work on..."></textarea>
        </div>
      </div>

      <!-- COACH-ONLY: Timestamped running record -->
      <div class="di-notes-card">
        <div class="section-title" style="color:var(--private-border);margin-bottom:1rem;">üîí Timestamped Observation Notes <span class="badge-private">Coach Only ‚Äî Not Shared</span></div>
        <div class="running-record-area" id="di-running-record-entries"></div>
        <button class="add-timestamp-btn" onclick="addDiTimestamp()" style="margin-top:.8rem;">&#43; Add Timestamped Entry</button>
      </div>

      <!-- COACH-ONLY: Private notes -->
      <div class="di-notes-card">
        <div class="section-title" style="color:var(--private-border);margin-bottom:.8rem;">üîí Coach-Only Reflections <span class="badge-private">Not Shared</span></div>
        <textarea id="di-coachnotes" placeholder="Private reflections, patterns, follow-up questions..."></textarea>
      </div>

      <div class="form-actions">
        <button class="btn-secondary" onclick="showView('dashboard')">Cancel</button>
        <button class="btn-teal" onclick="saveDiObservation()">üíæ Save Observation</button>
      </div>
    </div>
  </div>

  <!-- GENERAL DETAIL -->
  <div id="view-detail" class="view">
    <div class="container">
      <div class="detail-header">
        <div>
          <div style="display:flex;align-items:center;gap:.7rem;margin-bottom:.4rem;">
            <button class="btn-back" onclick="showView('dashboard')">&#8592;</button>
            <h1 id="d-teacher"></h1>
          </div>
          <div class="detail-meta">
            <span>üìÖ <span id="d-date"></span></span>
            <span>üìö <span id="d-section"></span></span>
          </div>
        </div>
        <div class="detail-actions">
          <button class="btn-secondary" onclick="editCurrent()">‚úèÔ∏è Edit</button>
          <button class="btn-teal" onclick="openShareModal()">üîó Share with Teacher</button>
          <button class="btn-danger" onclick="deleteCurrent()">Delete</button>
        </div>
      </div>
      <div class="detail-grid" style="margin-bottom:1rem;">
        <div class="detail-section"><h3>Objective <span class="badge-shared">Shared</span></h3><p id="d-objective"></p></div>
        <div class="detail-section"><h3>Do Now <span class="badge-shared">Shared</span></h3><p id="d-donow"></p></div>
      </div>
      <div class="detail-section"><h3>Action Step <span class="badge-shared">Shared</span></h3><p id="d-action"></p></div>
      <div class="detail-section private-section"><h3>Running Record <span class="badge-private">Coach Only</span></h3><div class="ts-list" id="d-running"></div></div>
      <div class="detail-section private-section"><h3>Coach-Only Notes <span class="badge-private">Not Shared</span></h3><p id="d-coachnotes"></p></div>
    </div>
  </div>

  <!-- DI DETAIL -->
  <div id="view-di-detail" class="view">
    <div class="container" style="max-width:960px;">
      <div class="detail-header">
        <div>
          <div style="display:flex;align-items:center;gap:.7rem;margin-bottom:.4rem;">
            <button class="btn-back" onclick="showView('dashboard')">&#8592;</button>
            <h1 id="did-teacher"></h1>
          </div>
          <div class="detail-meta">
            <span>üìÖ <span id="did-date"></span></span>
            <span>üìö <span id="did-section"></span></span>
            <span>üìñ <span id="did-topic"></span></span>
          </div>
        </div>
        <div class="detail-actions">
          <button class="btn-secondary" onclick="editDiCurrent()">‚úèÔ∏è Edit</button>
          <button class="btn-teal" onclick="openShareModal()">üîó Share with Teacher</button>
          <button class="btn-danger" onclick="deleteCurrent()">Delete</button>
        </div>
      </div>
      <!-- Score summary -->
      <div class="di-summary" style="margin-bottom:1rem;">
        <div>
          <h3>Scores</h3>
          <div class="di-summary-scores" id="did-scores"></div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:.7rem;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,.4);">Total</div>
          <div class="di-total" id="did-total">‚Äî</div>
          <div style="font-size:.7rem;color:rgba(255,255,255,.4);">/ 24</div>
        </div>
      </div>
      <!-- Rubric breakdown -->
      <div id="did-rubric-results"></div>
      <!-- Teacher-facing notes & action step -->
      <div class="detail-grid" style="margin-bottom:1rem;">
        <div class="detail-section" style="border-left:4px solid var(--shared-border);">
          <h3>Notes <span class="badge-shared">Shared</span></h3>
          <p id="did-notes"></p>
        </div>
        <div class="detail-section" style="border-left:4px solid var(--shared-border);">
          <h3>Action Step <span class="badge-shared">Shared</span></h3>
          <p id="did-actionstep"></p>
        </div>
      </div>
      <!-- Coach-only running record -->
      <div class="detail-section private-section">
        <h3>Timestamped Observation Notes <span class="badge-private">Coach Only</span></h3>
        <div class="ts-list" id="did-running"></div>
      </div>
      <!-- Coach-only reflections -->
      <div class="detail-section private-section">
        <h3>Coach-Only Reflections <span class="badge-private">Not Shared</span></h3>
        <p id="did-coachnotes"></p>
      </div>
    </div>
  </div>

  <!-- SHARE VIEW -->
  <div id="view-share" class="view">
    <div class="container" style="max-width:800px;">
      <div class="share-banner"><span>üëÅÔ∏è</span><div><strong>Teacher View</strong> ‚Äî Private notes are not included.</div></div>
      <div class="detail-header">
        <div>
          <h1 id="s-teacher"></h1>
          <div class="detail-meta"><span>üìÖ <span id="s-date"></span></span><span>üìö <span id="s-section"></span></span></div>
        </div>
        <button class="btn-back" onclick="goBackFromShare()">&#8592; Back to Full Log</button>
      </div>
      <div id="s-content"></div>
    </div>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="modal-overlay" id="share-modal">
  <div class="modal">
    <h2>Share with Teacher</h2>
    <p>Copy this link to share the teacher-facing view. Private notes and running records will <strong>not</strong> be visible.</p>
    <div class="share-link-box" id="share-link-display"></div>
    <button class="btn-teal" onclick="copyShareLink()" style="width:100%;">üìã Copy Link</button>
    <div class="copied-msg" id="copied-msg">‚úÖ Link copied!</div>
    <div class="modal-actions" style="margin-top:1rem;">
      <button class="btn-secondary" onclick="closeShareModal()">Close</button>
      <button class="btn-primary" onclick="previewShare()">Preview Teacher View</button>
    </div>
  </div>
</div>

<script>
// ===== DATA =====
const DI_SECTIONS = [
  { num:'I',   title:'Lesson Opening & Objective Setting',
    rows:[
      {score:4,label:'Exemplary', desc:'Learning objective is clearly stated, written/displayed, and explicitly connected to prior knowledge and real-world relevance. Students can articulate the goal in their own words.'},
      {score:3,label:'Proficient', desc:'Objective is clearly stated and visible. Connection to prior knowledge is made. Most students understand what they will learn.'},
      {score:2,label:'Developing', desc:'Objective is mentioned but not displayed or thoroughly explained. Limited connection to prior learning.'},
      {score:1,label:'Beginning',  desc:'No clear learning objective communicated. Students are unclear about the purpose of the lesson.'}
    ]
  },
  { num:'II',  title:'Content Knowledge & Explanation',
    rows:[
      {score:4,label:'Exemplary', desc:'Teacher demonstrates deep content mastery. Explanations are accurate, clear, and rich with multiple examples, analogies, and representations. Anticipates and addresses misconceptions proactively.'},
      {score:3,label:'Proficient', desc:'Content is accurate and explained clearly with at least one strong example or visual. Addresses most student misconceptions when they arise.'},
      {score:2,label:'Developing', desc:'Content is mostly accurate but explanations are vague or inconsistent. Examples are limited or unclear. Misconceptions are not always addressed.'},
      {score:1,label:'Beginning',  desc:'Content contains errors or is presented confusingly. No examples or visuals used. Misconceptions go unaddressed.'}
    ]
  },
  { num:'III', title:'Modeling & Think-Aloud',
    rows:[
      {score:4,label:'Exemplary', desc:'Teacher explicitly models the skill/process step-by-step with a robust think-aloud that makes invisible thinking visible. Models include what to do and what NOT to do.'},
      {score:3,label:'Proficient', desc:'Teacher models the skill clearly with a think-aloud. Steps are visible and logical. Students can follow the process.'},
      {score:2,label:'Developing', desc:'Some modeling occurs but think-aloud is incomplete or inconsistent. Steps may be rushed or unclear.'},
      {score:1,label:'Beginning',  desc:'No modeling or think-aloud. Students must infer expectations without a clear demonstration.'}
    ]
  },
  { num:'IV',  title:'Checking for Understanding',
    rows:[
      {score:4,label:'Exemplary', desc:'Multiple strategic checks are used throughout (e.g., cold-call, turn-and-talk, exit ticket, whiteboards). Teacher uses responses to adjust pacing or re-teach in real time.'},
      {score:3,label:'Proficient', desc:'At least two different checks for understanding are used. Teacher monitors responses and makes minor instructional adjustments.'},
      {score:2,label:'Developing', desc:'Checks for understanding occur but rely mainly on volunteered responses ("Does anyone have questions?"). Sampling is limited.'},
      {score:1,label:'Beginning',  desc:'No checks for understanding. Instruction proceeds without gauging student comprehension.'}
    ]
  },
  { num:'V',   title:'Student Engagement & Participation',
    rows:[
      {score:4,label:'Exemplary', desc:'Virtually all students are actively engaged throughout. Teacher uses varied techniques (equity sticks, partner talk, movement, choral response) to ensure broad participation.'},
      {score:3,label:'Proficient', desc:'Most students are on-task and engaged. Participation strategies are used; occasional off-task behavior is redirected effectively.'},
      {score:2,label:'Developing', desc:'Some students are disengaged. Participation is dominated by a few volunteers. Teacher does not consistently redirect off-task behavior.'},
      {score:1,label:'Beginning',  desc:'Many students are off-task. Participation strategies are absent. Instruction is primarily teacher-to-air.'}
    ]
  },
  { num:'VI',  title:'Lesson Closure & Transfer',
    rows:[
      {score:4,label:'Exemplary', desc:'Lesson closes with student-led synthesis of learning. Teacher explicitly bridges to future learning and assigns independent practice that is appropriately challenging.'},
      {score:3,label:'Proficient', desc:'Lesson closes with a clear summary of key learning. Students have an opportunity to reflect or respond. Next steps are communicated.'},
      {score:2,label:'Developing', desc:'Closure is brief or teacher-directed only. Limited opportunity for student reflection. Independent practice is assigned but not well connected to the lesson.'},
      {score:1,label:'Beginning',  desc:'No meaningful closure. Lesson ends abruptly or due to time. No connection to future learning.'}
    ]
  }
];

const SECTION_LABELS = ['Opening','Content','Modeling','CFU','Engagement','Closure'];
let diScores = {};
let currentUser=null, observations=[], currentId=null, editingId=null, tsCounter=0, diTsCounter=0;
const ACCOUNTS_KEY='coachlog_accounts', SESSION_KEY='coachlog_session';

async function hashPw(pw){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode('cl_salt_'+pw));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function sGet(k,shared=false){try{const r=await window.storage.get(k,shared);return r?JSON.parse(r.value):null;}catch(e){return null;}}
async function sSet(k,v,shared=false){try{await window.storage.set(k,JSON.stringify(v),shared);}catch(e){}}
async function sDel(k,shared=false){try{await window.storage.delete(k,shared);}catch(e){}}
async function getAccounts(){return(await sGet(ACCOUNTS_KEY,true))||{};}
async function setAccounts(a){await sSet(ACCOUNTS_KEY,a,true);}
function obsKey(id){return 'coachlog_obs_'+id;}
async function loadObs(){observations=(await sGet(obsKey(currentUser.id)))||[];}
async function saveObs(){await sSet(obsKey(currentUser.id),observations);}

// ===== DROPDOWN =====
function toggleLogMenu(){
  const btn=document.getElementById('new-log-toggle');
  const menu=document.getElementById('new-log-menu');
  btn.classList.toggle('open');
  menu.classList.toggle('open');
}
document.addEventListener('click',e=>{
  const wrapper=document.getElementById('new-log-wrapper');
  if(wrapper&&!wrapper.contains(e.target)){
    document.getElementById('new-log-toggle')?.classList.remove('open');
    document.getElementById('new-log-menu')?.classList.remove('open');
  }
});

// ===== AUTH =====
function switchAuthTab(tab){
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',(i===0&&tab==='login')||(i===1&&tab==='signup')));
  document.getElementById('login-form').style.display=tab==='login'?'block':'none';
  document.getElementById('signup-form').style.display=tab==='signup'?'block':'none';
  showAuthErr('');
}
function showAuthErr(msg){const el=document.getElementById('auth-error');el.textContent=msg;el.classList.toggle('show',!!msg);}
async function handleLogin(){
  const email=document.getElementById('login-email').value.trim().toLowerCase();
  const pw=document.getElementById('login-password').value;
  if(!email||!pw){showAuthErr('Please enter your email and password.');return;}
  const accounts=await getAccounts(), acct=accounts[email];
  if(!acct){showAuthErr('No account found for that email address.');return;}
  if((await hashPw(pw))!==acct.pwHash){showAuthErr('Incorrect password.');return;}
  await signIn({id:acct.id,email,name:acct.name});
}
async function handleSignup(){
  const name=document.getElementById('signup-name').value.trim();
  const email=document.getElementById('signup-email').value.trim().toLowerCase();
  const pw=document.getElementById('signup-password').value;
  const confirm=document.getElementById('signup-confirm').value;
  if(!name){showAuthErr('Please enter your name.');return;}
  if(!email||!email.includes('@')){showAuthErr('Please enter a valid email address.');return;}
  if(pw.length<6){showAuthErr('Password must be at least 6 characters.');return;}
  if(pw!==confirm){showAuthErr('Passwords do not match.');return;}
  const accounts=await getAccounts();
  if(accounts[email]){showAuthErr('An account with this email already exists.');return;}
  const id=uid();
  accounts[email]={id,name,pwHash:await hashPw(pw)};
  await setAccounts(accounts);
  await signIn({id,email,name});
}
async function signIn(user){
  currentUser=user;
  await sSet(SESSION_KEY,user);
  await loadObs();
  document.getElementById('header-name').textContent=user.name;
  document.getElementById('header-email').textContent=user.email;
  document.getElementById('auth-wrapper').classList.remove('active');
  document.getElementById('app-wrapper').classList.add('active');
  showView('dashboard');
}
async function handleSignOut(){
  currentUser=null;observations=[];
  await sDel(SESSION_KEY);
  document.getElementById('app-wrapper').classList.remove('active');
  document.getElementById('auth-wrapper').classList.add('active');
  ['login-email','login-password'].forEach(id=>document.getElementById(id).value='');
  showAuthErr('');switchAuthTab('login');
}
function checkPwStrength(pw){
  let s=0;
  if(pw.length>=6)s++;if(pw.length>=10)s++;if(/[A-Z]/.test(pw))s++;if(/[0-9]/.test(pw))s++;if(/[^A-Za-z0-9]/.test(pw))s++;
  const bar=document.getElementById('pw-bar');
  bar.style.width=(s/5*100)+'%';
  bar.style.background=['#e57373','#ff8a65','#ffd54f','#81c784','#43a047'][Math.min(s-1,4)]||'#ccc';
  document.getElementById('pw-hint').textContent=pw.length===0?'Choose a strong password':['Too short','Weak','Fair','Good','Strong'][Math.min(s-1,4)]||'Too short';
}

// ===== VIEWS =====
function showView(name){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  document.querySelectorAll('header nav button').forEach(b=>b.classList.remove('active'));
  if(name==='dashboard'){document.querySelector('header nav button').classList.add('active');renderDashboard();}
  document.getElementById('new-log-toggle')?.classList.remove('open');
  document.getElementById('new-log-menu')?.classList.remove('open');
  window.scrollTo(0,0);
}

// ===== DASHBOARD =====
function renderDashboard(){
  const q=(document.getElementById('search-input')?.value||'').toLowerCase();
  const sort=document.getElementById('sort-select')?.value||'newest';
  let list=[...observations];
  if(q)list=list.filter(o=>o.teacher.toLowerCase().includes(q)||(o.section||'').toLowerCase().includes(q));
  if(sort==='newest')list.sort((a,b)=>new Date(b.date)-new Date(a.date));
  else if(sort==='oldest')list.sort((a,b)=>new Date(a.date)-new Date(b.date));
  else list.sort((a,b)=>a.teacher.localeCompare(b.teacher));
  const grid=document.getElementById('obs-grid');
  if(!list.length){
    grid.innerHTML=`<div class="empty-state"><div class="icon">üìã</div><h3>${q?'No results found':'No observations yet'}</h3><p>${q?'Try a different search.':'Use the &ldquo;+ New Log&rdquo; dropdown to start your first observation.'}</p></div>`;
    return;
  }
  grid.innerHTML=list.map(o=>{
    const isDi=o.type==='di';
    const typeChip=isDi?`<span class="chip chip-gold">üìä Direct Instruction</span>`:`<span class="chip chip-teal">üìã General</span>`;
    const preview=isDi?(o.scores?`Total Score: ${Object.values(o.scores).reduce((a,b)=>a+b,0)}/24`:''):(o.actionStep||'');
    return `<div class="obs-card type-${isDi?'di':'general'}" onclick="viewObservation('${o.id}')">
      <div class="obs-card-info">
        <h3>${esc(o.teacher)}</h3>
        <div class="obs-card-meta"><span>üìÖ ${formatDate(o.date)}</span><span>üìö ${esc(o.section||'‚Äî')}</span>${typeChip}</div>
        ${preview?`<div class="obs-card-preview">${esc(preview)}</div>`:''}
      </div>
      <div class="obs-card-actions" onclick="event.stopPropagation()">
        <button class="btn-teal" onclick="viewObservation('${o.id}')">View</button>
        <button class="btn-secondary" onclick="editObservation('${o.id}')">Edit</button>
      </div>
    </div>`;
  }).join('');
}

// ===== GENERAL FORM =====
function newObservation(type='general'){
  document.getElementById('new-log-toggle')?.classList.remove('open');
  document.getElementById('new-log-menu')?.classList.remove('open');
  editingId=null;
  if(type==='di'){newDiObservation();return;}
  document.getElementById('form-title').textContent='New Observation';
  ['f-teacher','f-section','f-objective','f-donow','f-action','f-coachnotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-date').value=today();
  document.getElementById('running-record-entries').innerHTML='';
  addTimestamp();
  showView('form');
}
function editObservation(id){
  const o=observations.find(x=>x.id===id);if(!o)return;
  if(o.type==='di'){editDiObservation(id);return;}
  editingId=id;
  document.getElementById('form-title').textContent='Edit Observation';
  document.getElementById('f-teacher').value=o.teacher;
  document.getElementById('f-date').value=o.date;
  document.getElementById('f-section').value=o.section||'';
  document.getElementById('f-objective').value=o.objective||'';
  document.getElementById('f-donow').value=o.donow||'';
  document.getElementById('f-action').value=o.actionStep||'';
  document.getElementById('f-coachnotes').value=o.coachNotes||'';
  const container=document.getElementById('running-record-entries');
  container.innerHTML='';
  if(o.runningRecord?.length)o.runningRecord.forEach(e=>addTimestamp(e.time,e.text));
  else addTimestamp();
  showView('form');
}
function editCurrent(){editObservation(currentId);}
function addTimestamp(time,text){
  tsCounter++;
  const id='ts-'+tsCounter, now=time||currentTime();
  const container=document.getElementById('running-record-entries');
  const div=document.createElement('div');
  div.className='timestamp-entry';div.id=id;
  div.innerHTML=`<div class="timestamp-label">${now}</div><textarea class="timestamp-text" rows="1" placeholder="What's happening in the room...">${text||''}</textarea><button class="remove-ts" onclick="document.getElementById('${id}').remove()">‚úï</button>`;
  container.appendChild(div);
  const ta=div.querySelector('textarea');
  ta.addEventListener('input',()=>{ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';});
  if(text){ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';}
}
async function saveObservation(){
  const teacher=document.getElementById('f-teacher').value.trim();
  const date=document.getElementById('f-date').value;
  if(!teacher||!date){alert('Please enter at least a teacher name and date.');return;}
  const entries=[];
  document.querySelectorAll('.timestamp-entry').forEach(row=>{
    const time=row.querySelector('.timestamp-label').textContent;
    const text=row.querySelector('textarea').value.trim();
    if(text)entries.push({time,text});
  });
  const obs={
    id:editingId||uid(),type:'general',teacher,date,
    section:document.getElementById('f-section').value.trim()||'‚Äî',
    objective:document.getElementById('f-objective').value.trim(),
    donow:document.getElementById('f-donow').value.trim(),
    actionStep:document.getElementById('f-action').value.trim(),
    coachNotes:document.getElementById('f-coachnotes').value.trim(),
    runningRecord:entries,
    createdAt:editingId?(observations.find(x=>x.id===editingId)?.createdAt||Date.now()):Date.now()
  };
  if(editingId){const idx=observations.findIndex(x=>x.id===editingId);observations[idx]=obs;}
  else observations.unshift(obs);
  await saveObs();
  currentId=obs.id;
  viewObservation(obs.id);
}

// ===== GENERAL DETAIL =====
function viewObservation(id){
  currentId=id;
  const o=observations.find(x=>x.id===id);if(!o)return;
  if(o.type==='di'){viewDiObservation(id);return;}
  document.getElementById('d-teacher').textContent=o.teacher;
  document.getElementById('d-date').textContent=formatDate(o.date);
  document.getElementById('d-section').textContent=o.section||'‚Äî';
  document.getElementById('d-objective').textContent=o.objective||'‚Äî';
  document.getElementById('d-donow').textContent=o.donow||'‚Äî';
  document.getElementById('d-action').textContent=o.actionStep||'‚Äî';
  document.getElementById('d-coachnotes').textContent=o.coachNotes||'‚Äî';
  const rr=document.getElementById('d-running');
  rr.innerHTML=o.runningRecord?.length
    ?o.runningRecord.map(e=>`<div class="ts-item"><span class="ts-badge">${e.time}</span><span class="ts-content">${esc(e.text)}</span></div>`).join('')
    :'<span style="color:var(--ink-muted);font-size:.9rem;">No entries recorded.</span>';
  showView('detail');
}
async function deleteCurrent(){
  if(!confirm('Delete this observation? This cannot be undone.'))return;
  observations=observations.filter(x=>x.id!==currentId);
  await saveObs();currentId=null;showView('dashboard');
}

// ===== DI RUBRIC FORM =====
function buildDiRubric(){
  const container=document.getElementById('di-rubric-sections');
  container.innerHTML=DI_SECTIONS.map((sec,si)=>`
    <div class="rubric-section">
      <div class="rubric-section-header">
        <span class="rubric-section-num">${sec.num}</span>
        <span class="rubric-section-title">${sec.title}</span>
      </div>
      <table class="rubric-table">
        <thead><tr><th class="col-score">Score</th><th>Descriptor</th><th class="col-obs">Observed</th></tr></thead>
        <tbody>
          ${sec.rows.map(row=>{
            const cls=['s4b','s3b','s2b','s1b'][[4,3,2,1].indexOf(row.score)];
            const lcls=['s4l','s3l','s2l','s1l'][[4,3,2,1].indexOf(row.score)];
            const ccls=['c4','c3','c2','c1'][[4,3,2,1].indexOf(row.score)];
            return `<tr>
              <td class="score-cell"><div class="score-badge-di ${cls}">${row.score}</div><span class="score-lbl ${lcls}">${row.label}</span></td>
              <td>${row.desc}</td>
              <td class="score-cell">
                <label class="chk-wrap ${ccls}">
                  <input type="checkbox" data-section="${si}" data-score="${row.score}" onchange="diCheckChanged(this)">
                  <div class="chk-box"></div>
                </label>
              </td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`).join('');
}

function diCheckChanged(cb){
  const si=parseInt(cb.dataset.section);
  const score=parseInt(cb.dataset.score);
  if(cb.checked){
    document.querySelectorAll(`[data-section="${si}"]`).forEach(c=>{if(c!==cb)c.checked=false;});
    diScores[si]=score;
  } else {
    delete diScores[si];
  }
  updateDiSummary();
}

function updateDiSummary(){
  const keys=Object.keys(diScores).map(Number).sort();
  const summaryEl=document.getElementById('di-summary-scores');
  const totalEl=document.getElementById('di-total');
  if(!keys.length){
    summaryEl.innerHTML='<span style="color:rgba(255,255,255,.5);font-size:.82rem;">No scores recorded yet.</span>';
    totalEl.textContent='‚Äî';return;
  }
  const scoreColors={4:'var(--s4)',3:'var(--s3)',2:'var(--s2)',1:'var(--s1)'};
  summaryEl.innerHTML=keys.map(si=>`<span style="color:${scoreColors[diScores[si]]}">${SECTION_LABELS[si]}: <strong>${diScores[si]}</strong></span>`).join('<span style="color:rgba(255,255,255,.3)"> | </span>');
  totalEl.textContent=keys.reduce((a,k)=>a+diScores[k],0);
}

// DI timestamped entries
function addDiTimestamp(time,text){
  diTsCounter++;
  const id='dits-'+diTsCounter, now=time||currentTime();
  const container=document.getElementById('di-running-record-entries');
  const div=document.createElement('div');
  div.className='timestamp-entry';div.id=id;
  div.innerHTML=`<div class="timestamp-label">${now}</div><textarea class="timestamp-text" rows="1" placeholder="What's happening in the room...">${text||''}</textarea><button class="remove-ts" onclick="document.getElementById('${id}').remove()">‚úï</button>`;
  container.appendChild(div);
  const ta=div.querySelector('textarea');
  ta.addEventListener('input',()=>{ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';});
  if(text){ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';}
}

function newDiObservation(){
  editingId=null;
  diScores={};
  document.getElementById('di-form-title').textContent='New Direct Instruction Observation';
  ['di-teacher','di-grade','di-topic','di-section','di-notes','di-actionstep','di-coachnotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('di-date').value=today();
  document.getElementById('di-running-record-entries').innerHTML='';
  buildDiRubric();
  updateDiSummary();
  addDiTimestamp();
  showView('di-form');
}

function editDiObservation(id){
  editingId=id;
  const o=observations.find(x=>x.id===id);if(!o)return;
  document.getElementById('di-form-title').textContent='Edit Direct Instruction Observation';
  document.getElementById('di-teacher').value=o.teacher;
  document.getElementById('di-date').value=o.date;
  document.getElementById('di-grade').value=o.grade||'';
  document.getElementById('di-topic').value=o.topic||'';
  document.getElementById('di-section').value=o.section||'';
  document.getElementById('di-notes').value=o.teacherNotes||'';
  document.getElementById('di-actionstep').value=o.actionStep||'';
  document.getElementById('di-coachnotes').value=o.coachNotes||'';
  diScores=Object.assign({},o.scores||{});
  buildDiRubric();
  Object.entries(diScores).forEach(([si,score])=>{
    const cb=document.querySelector(`[data-section="${si}"][data-score="${score}"]`);
    if(cb)cb.checked=true;
  });
  updateDiSummary();
  // Restore running record
  const container=document.getElementById('di-running-record-entries');
  container.innerHTML='';
  if(o.runningRecord?.length)o.runningRecord.forEach(e=>addDiTimestamp(e.time,e.text));
  else addDiTimestamp();
  showView('di-form');
}

function editDiCurrent(){editDiObservation(currentId);}

async function saveDiObservation(){
  const teacher=document.getElementById('di-teacher').value.trim();
  const date=document.getElementById('di-date').value;
  if(!teacher||!date){alert('Please enter at least a teacher name and date.');return;}
  // Collect running record
  const entries=[];
  document.querySelectorAll('#di-running-record-entries .timestamp-entry').forEach(row=>{
    const time=row.querySelector('.timestamp-label').textContent;
    const text=row.querySelector('textarea').value.trim();
    if(text)entries.push({time,text});
  });
  const obs={
    id:editingId||uid(),type:'di',teacher,date,
    grade:document.getElementById('di-grade').value.trim(),
    topic:document.getElementById('di-topic').value.trim(),
    section:document.getElementById('di-section').value.trim()||'‚Äî',
    teacherNotes:document.getElementById('di-notes').value.trim(),
    actionStep:document.getElementById('di-actionstep').value.trim(),
    coachNotes:document.getElementById('di-coachnotes').value.trim(),
    scores:{...diScores},
    runningRecord:entries,
    createdAt:editingId?(observations.find(x=>x.id===editingId)?.createdAt||Date.now()):Date.now()
  };
  if(editingId){const idx=observations.findIndex(x=>x.id===editingId);observations[idx]=obs;}
  else observations.unshift(obs);
  await saveObs();
  currentId=obs.id;
  viewDiObservation(obs.id);
}

// ===== DI DETAIL =====
function viewDiObservation(id){
  currentId=id;
  const o=observations.find(x=>x.id===id);if(!o)return;
  document.getElementById('did-teacher').textContent=o.teacher;
  document.getElementById('did-date').textContent=formatDate(o.date);
  document.getElementById('did-section').textContent=o.section||'‚Äî';
  document.getElementById('did-topic').textContent=o.topic||'‚Äî';
  document.getElementById('did-coachnotes').textContent=o.coachNotes||'‚Äî';
  document.getElementById('did-notes').textContent=o.teacherNotes||'‚Äî';
  document.getElementById('did-actionstep').textContent=o.actionStep||'‚Äî';
  // Scores summary
  const scores=o.scores||{};
  const keys=Object.keys(scores).map(Number).sort();
  const scoreColors={4:'var(--s4)',3:'var(--s3)',2:'var(--s2)',1:'var(--s1)'};
  document.getElementById('did-scores').innerHTML=keys.length
    ?keys.map(si=>`<span style="color:${scoreColors[scores[si]]}">${SECTION_LABELS[si]}: <strong>${scores[si]}</strong></span>`).join('<span style="color:rgba(255,255,255,.3)"> | </span>')
    :'<span style="color:rgba(255,255,255,.5)">No scores recorded.</span>';
  document.getElementById('did-total').textContent=keys.length?keys.reduce((a,k)=>a+scores[k],0):'‚Äî';
  // Rubric breakdown
  const results=document.getElementById('did-rubric-results');
  results.innerHTML=DI_SECTIONS.map((sec,si)=>{
    const sc=scores[si];
    const row=sc?sec.rows.find(r=>r.score===sc):null;
    const color=sc?scoreColors[sc]:'var(--ink-muted)';
    return `<div class="di-rubric-detail">
      <div class="di-rubric-detail-header">
        <span class="rubric-section-num">${sec.num}</span>
        <span class="rubric-section-title">${sec.title}</span>
      </div>
      <div class="di-rubric-detail-content">
        ${row
          ?`<div class="di-score-display"><span class="di-score-pill" style="background:${color}">${sc} ‚Äî ${row.label}</span></div><p style="font-size:.9rem;color:var(--ink-light);line-height:1.6;">${row.desc}</p>`
          :'<p style="color:var(--ink-muted);font-size:.88rem;">Not scored.</p>'
        }
      </div>
    </div>`;
  }).join('');
  // Running record
  const rr=document.getElementById('did-running');
  rr.innerHTML=o.runningRecord?.length
    ?o.runningRecord.map(e=>`<div class="ts-item"><span class="ts-badge">${e.time}</span><span class="ts-content">${esc(e.text)}</span></div>`).join('')
    :'<span style="color:var(--ink-muted);font-size:.9rem;">No entries recorded.</span>';
  showView('di-detail');
}

// ===== SHARE =====
let shareFromView='detail';
function openShareModal(){
  const o=observations.find(x=>x.id===currentId);if(!o)return;
  shareFromView=o.type==='di'?'di-detail':'detail';
  const url=window.location.href.split('?')[0]+'?share='+currentId+'&coach='+currentUser.id;
  document.getElementById('share-link-display').textContent=url;
  document.getElementById('copied-msg').style.display='none';
  document.getElementById('share-modal').classList.add('open');
}
function closeShareModal(){document.getElementById('share-modal').classList.remove('open');}
function copyShareLink(){
  navigator.clipboard.writeText(document.getElementById('share-link-display').textContent)
    .then(()=>{document.getElementById('copied-msg').style.display='block';});
}
function previewShare(){closeShareModal();loadShareView(currentId);}
function goBackFromShare(){showView(shareFromView);}

function loadShareView(id){
  const o=observations.find(x=>x.id===id);if(!o)return;
  document.getElementById('s-teacher').textContent=o.teacher;
  document.getElementById('s-date').textContent=formatDate(o.date);
  document.getElementById('s-section').textContent=o.section||'‚Äî';
  const content=document.getElementById('s-content');
  if(o.type==='di'){
    const scores=o.scores||{};
    const keys=Object.keys(scores).map(Number).sort();
    const scoreColors={4:'var(--s4)',3:'var(--s3)',2:'var(--s2)',1:'var(--s1)'};
    const total=keys.reduce((a,k)=>a+scores[k],0);
    content.innerHTML=`
      <div class="di-summary" style="margin-bottom:1rem;">
        <div><h3>Scores</h3>
          <div class="di-summary-scores">${keys.length
            ?keys.map(si=>`<span style="color:${scoreColors[scores[si]]}">${SECTION_LABELS[si]}: <strong>${scores[si]}</strong></span>`).join('<span style="color:rgba(255,255,255,.3)"> | </span>')
            :'<span style="color:rgba(255,255,255,.5)">No scores recorded.</span>'
          }</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:.7rem;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,.4);">Total</div>
          <div class="di-total">${keys.length?total:'‚Äî'}</div>
          <div style="font-size:.7rem;color:rgba(255,255,255,.4);">/ 24</div>
        </div>
      </div>
      ${DI_SECTIONS.map((sec,si)=>{
        const sc=scores[si];
        const row=sc?sec.rows.find(r=>r.score===sc):null;
        const color=sc?scoreColors[sc]:'var(--ink-muted)';
        return `<div class="di-rubric-detail">
          <div class="di-rubric-detail-header"><span class="rubric-section-num">${sec.num}</span><span class="rubric-section-title">${sec.title}</span></div>
          <div class="di-rubric-detail-content">
            ${row?`<div class="di-score-display"><span class="di-score-pill" style="background:${color}">${sc} ‚Äî ${row.label}</span></div><p style="font-size:.9rem;color:var(--ink-light);line-height:1.6;">${row.desc}</p>`:'<p style="color:var(--ink-muted);font-size:.88rem;">Not scored.</p>'}
          </div>
        </div>`;
      }).join('')}
      <div class="detail-grid" style="margin-top:1rem;">
        <div class="detail-section" style="border-left:4px solid var(--shared-border);">
          <h3>Notes</h3>
          <p>${esc(o.teacherNotes||'‚Äî')}</p>
        </div>
        <div class="detail-section" style="border-left:4px solid var(--shared-border);">
          <h3>Action Step</h3>
          <p>${esc(o.actionStep||'‚Äî')}</p>
        </div>
      </div>`;
  } else {
    content.innerHTML=`
      <div class="detail-grid" style="margin-bottom:1rem;">
        <div class="detail-section"><h3>Objective</h3><p>${esc(o.objective||'‚Äî')}</p></div>
        <div class="detail-section"><h3>Do Now</h3><p>${esc(o.donow||'‚Äî')}</p></div>
      </div>
      <div class="detail-section"><h3>Action Step</h3><p>${esc(o.actionStep||'‚Äî')}</p></div>`;
  }
  showView('share');
}

async function checkShareUrl(){
  const params=new URLSearchParams(window.location.search);
  const shareId=params.get('share'),coachId=params.get('coach');
  if(!shareId||!coachId)return false;
  try{
    const sharedObs=(await sGet(obsKey(coachId)))||[];
    const o=sharedObs.find(x=>x.id===shareId);
    if(o){
      document.getElementById('auth-wrapper').classList.remove('active');
      document.getElementById('app-wrapper').classList.add('active');
      document.querySelector('header').style.display='none';
      observations=sharedObs;currentId=shareId;
      loadShareView(shareId);return true;
    }
  }catch(e){}
  return false;
}

// ===== UTILS =====
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6);}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function today(){return new Date().toISOString().slice(0,10);}
function currentTime(){return new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});}
function formatDate(d){return d?new Date(d+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'‚Äî';}

document.getElementById('login-password').addEventListener('keydown',e=>{if(e.key==='Enter')handleLogin();});
document.getElementById('signup-confirm').addEventListener('keydown',e=>{if(e.key==='Enter')handleSignup();});
document.getElementById('share-modal').addEventListener('click',function(e){if(e.target===this)closeShareModal();});

async function init(){
  if(await checkShareUrl())return;
  const session=await sGet(SESSION_KEY);
  if(session){await signIn(session);}
  else{document.getElementById('auth-wrapper').classList.add('active');}
}
init();
</script>
</body>
</html>
